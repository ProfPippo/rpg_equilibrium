<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>RPG Escolar XP</title>

<style>
body{
  font-family: Arial;
  background:#0f172a;
  color:white;
  padding:20px;
}

button,input{
  padding:6px 10px;
  border-radius:6px;
  border:none;
  margin:3px;
  cursor:pointer;
}

.tabs button{
  background:#1f2937;
  color:white;
}

.tabs .ativo{
  background:#22c55e;
  color:black;
}

.card{
  background:#1f2937;
  padding:10px;
  border-radius:10px;
  margin:8px 0;
  display:flex;
  gap:10px;
  align-items:center;
}

.foto{
  width:55px;
  height:55px;
  border-radius:50%;
  object-fit:cover;
  background:#333;
}

.bar{
  height:8px;
  background:#374151;
  border-radius:10px;
  margin-top:4px;
}

.fill{
  height:100%;
  background:#22c55e;
}
</style>
</head>

<body>

<h1>âš”ï¸ RPG Escolar XP</h1>

<button onclick="baixar()">ğŸ’¾ Baixar dados</button>
<input type="file" onchange="carregar(event)">

<hr>

<div class="tabs" id="tabs"></div>

<br>

<input id="nome" placeholder="Nome do aluno">
<input id="classe" placeholder="Classe">
<button onclick="addAluno()">Adicionar aluno</button>

<hr>

<div id="lista"></div>

<script>
/* =========================
   VARIÃVEIS
========================= */

let dados=[];
let anoAtual="6";

/* =========================
   CARREGAR JSON
========================= */

async function carregarDados(){
  try{
    const r=await fetch("dados.json?"+Date.now());
    dados=await r.json();
  }catch{
    dados=[];
  }
  render();
}

carregarDados();

/* =========================
   ANOS
========================= */

const anos=["6","7","8","9"];
const tabs=document.getElementById("tabs");

anos.forEach(a=>{
  const b=document.createElement("button");
  b.innerText=a+"Âº Ano";
  b.onclick=()=>{anoAtual=a;render()};
  tabs.appendChild(b);
});

/* =========================
   ADICIONAR
========================= */

function addAluno(){

  if(!nome.value.trim()) return;

  dados.push({
    id: Date.now(),
    ano:anoAtual,
    nome:nome.value,
    classe:classe.value,
    nivel:1,
    xp:0,
    foto:""
  });

  nome.value="";
  classe.value="";

  render();
}

/* =========================
   XP
========================= */

function addXP(id,val){

  const a=dados.find(x=>x.id===id);

  a.xp+=val;

  while(a.xp>=1000){
    a.xp-=1000;
    a.nivel++;
  }

  render();
}

/* =========================
   EDITAR / EXCLUIR
========================= */

function editar(id){

  const a=dados.find(x=>x.id===id);

  const n=prompt("Nome:",a.nome);
  if(!n) return;

  const c=prompt("Classe:",a.classe);

  a.nome=n;
  a.classe=c;

  render();
}

function excluir(id){

  dados=dados.filter(x=>x.id!==id);

  render();
}

/* =========================
   FOTO
========================= */

function mudarFoto(id){

  const input=document.createElement("input");
  input.type="file";
  input.accept="image/*";

  input.onchange=()=>{
    const reader=new FileReader();
    reader.onload=()=>{
      dados.find(x=>x.id===id).foto=reader.result;
      render();
    };
    reader.readAsDataURL(input.files[0]);
  };

  input.click();
}

/* =========================
   RENDER
========================= */

function render(){

  lista.innerHTML="";

  // atualizar abas
  [...tabs.children].forEach(b=>{
    b.classList.remove("ativo");
    if(b.innerText.startsWith(anoAtual)) b.classList.add("ativo");
  });

  const alunos=dados
    .filter(a=>a.ano===anoAtual)
    .sort((a,b)=>(b.nivel*1000+b.xp)-(a.nivel*1000+a.xp));

  alunos.forEach(a=>{

    const pct=(a.xp/1000)*100;

    lista.innerHTML+=`
      <div class="card">

        <img class="foto" src="${a.foto||''}">

        <div style="flex:1">
          <strong>${a.nome}</strong> â€” Nv ${a.nivel}<br>
          ${a.classe}

          <div class="bar">
            <div class="fill" style="width:${pct}%"></div>
          </div>

          XP ${a.xp}/1000<br>

          <button onclick="addXP(${a.id},5)">+5</button>
          <button onclick="addXP(${a.id},10)">+10</button>
          <button onclick="addXP(${a.id},20)">+20</button>
          <button onclick="addXP(${a.id},30)">+30</button>
          <button onclick="addXP(${a.id},50)">+50</button>

          <button onclick="editar(${a.id})">âœï¸</button>
          <button onclick="excluir(${a.id})">ğŸ—‘ï¸</button>
          <button onclick="mudarFoto(${a.id})">ğŸ“·</button>
        </div>
      </div>
    `;
  });
}

/* =========================
   SALVAR / CARREGAR LOCAL
========================= */

function baixar(){
  const blob=new Blob([JSON.stringify(dados,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="dados.json";
  a.click();
}

function carregar(e){
  const reader=new FileReader();
  reader.onload=()=>{
    dados=JSON.parse(reader.result);
    render();
  };
  reader.readAsText(e.target.files[0]);
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>RPG Escolar Online</title>

<style>
body{
  font-family: Arial;
  background:#111827;
  color:white;
  padding:20px;
}

input,button{
  padding:8px;
  border-radius:8px;
  border:none;
  margin:4px;
}

button{cursor:pointer}

.tabs button{background:#1f2937;color:white}
.tabs .ativa{background:#22c55e;color:black}

.card{
  background:#1f2937;
  padding:12px;
  margin:10px 0;
  border-radius:12px;
  display:flex;
  gap:12px;
}

.foto{
  width:70px;height:70px;border-radius:50%;object-fit:cover;
  background:#374151;
}

.bar{
  height:10px;background:#374151;border-radius:10px;overflow:hidden;
}

.fill{height:100%;background:#22c55e}

.botoes{display:flex;gap:5px;flex-wrap:wrap;margin-top:5px}
</style>
</head>

<body>

<h1>âš”ï¸ RPG Escolar Online</h1>

<div class="tabs">
  <button onclick="trocarAno('6')" id="tab6">6Âº</button>
  <button onclick="trocarAno('7')" id="tab7">7Âº</button>
  <button onclick="trocarAno('8')" id="tab8">8Âº</button>
  <button onclick="trocarAno('9')" id="tab9">9Âº</button>
</div>

<h3>Adicionar aluno</h3>
<input id="nome" placeholder="Nome">
<input id="classe" placeholder="Classe">
<button onclick="addAluno()">Cadastrar</button>

<div id="lista"></div>


<script>
const API = "https://script.google.com/macros/s/AKfycbzF1mHyHAeqecPf1bR93Pt2Ni66t-YYbrqWBjs5vJoW4ixnzL6ujF1SQ-eUxxjsIpG9/exec";

let dados = [];
let anoAtual = "6";


async function carregar(){
  const res = await fetch(API);
  dados = await res.json();

  if(dados.length === 0){
    dados = [["Ano","Nome","Classe","Nivel","XP","Foto"]];
  }

  render();
}


async function salvar(){
  await fetch(API,{
    method:"POST",
    body:JSON.stringify(dados)
  });
}


function trocarAno(a){
  anoAtual=a;
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("ativa"));
  document.getElementById("tab"+a).classList.add("ativa");
  render();
}


function addAluno(){
  const nome = document.getElementById("nome").value;
  const classe = document.getElementById("classe").value;

  if(!nome) return;

  dados.push([anoAtual,nome,classe,1,0,""]);
  salvar();
  render();
}


function addXP(index,val){
  const alunos = getAlunosDoAno();

  alunos[index][4]+=val;

  while(alunos[index][4]>=1000){
    alunos[index][4]-=1000;
    alunos[index][3]++;
  }

  salvar();
  render();
}


function editar(index){
  const alunos = getAlunosDoAno();
  const a = alunos[index];

  const nome = prompt("Nome:",a[1]);
  if(!nome) return;

  const classe = prompt("Classe:",a[2]);

  a[1]=nome;
  a[2]=classe;

  salvar();
  render();
}


function excluir(index){
  const alunos = getAlunosDoAno();
  const realIndex = dados.indexOf(alunos[index]);

  dados.splice(realIndex,1);
  salvar();
  render();
}


function foto(event,index){
  const file = event.target.files[0];
  const reader = new FileReader();

  reader.onload = e=>{
    const alunos = getAlunosDoAno();
    alunos[index][5]=e.target.result;
    salvar();
    render();
  };

  reader.readAsDataURL(file);
}


function getAlunosDoAno(){
  return dados.filter((r,i)=> i>0 && r[0]===anoAtual);
}


function render(){
  const div = document.getElementById("lista");
  div.innerHTML="";

  const alunos = getAlunosDoAno();

  alunos.sort((a,b)=>(b[3]*1000+b[4])-(a[3]*1000+a[4]));

  alunos.forEach((a,i)=>{

    const pct=(a[4]/1000)*100;

    div.innerHTML+=`
    <div class="card">

      <label>
        <img src="${a[5]}" class="foto">
        <input type="file" style="display:none" accept="image/*" onchange="foto(event,${i})">
      </label>

      <div style="flex:1">

        <strong>${a[1]}</strong> â€” Nv ${a[3]}<br>
        ${a[2]}

        <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
        XP ${a[4]}/1000

        <div class="botoes">
          <button onclick="addXP(${i},5)">+5</button>
          <button onclick="addXP(${i},10)">+10</button>
          <button onclick="addXP(${i},20)">+20</button>
          <button onclick="addXP(${i},30)">+30</button>
          <button onclick="addXP(${i},50)">+50</button>
        </div>

        <div class="botoes">
          <button onclick="editar(${i})">âœï¸</button>
          <button onclick="excluir(${i})">ğŸ—‘ï¸</button>
        </div>

      </div>

    </div>`;
  });
}


carregar();
trocarAno("6");
</script>

</body>
</html>

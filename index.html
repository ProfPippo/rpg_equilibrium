<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"/>
<title>RPG Escolar</title>

<style>
body{
  font-family:Arial;
  background:#111827;
  color:white;
  padding:20px;
}

button,input{
  padding:6px;
  border-radius:6px;
  border:none;
  margin:3px;
}

.tabs button{background:#1f2937;color:white}
.tabs .ativa{background:#22c55e;color:black}

.card{
  background:#1f2937;
  padding:10px;
  border-radius:10px;
  margin:8px 0;
  display:flex;
  gap:10px;
  align-items:center;
}

.bar{height:8px;background:#374151;border-radius:10px}
.fill{height:100%;background:#22c55e}

.foto{
  width:60px;
  height:60px;
  border-radius:50%;
  object-fit:cover;
  background:#333;
}
</style>
</head>

<body>

<h1>âš”ï¸ RPG Escolar</h1>

<div class="tabs">
  <button onclick="trocarAno('6')">6Âº Ano</button>
  <button onclick="trocarAno('7')">7Âº Ano</button>
  <button onclick="trocarAno('8')">8Âº Ano</button>
  <button onclick="trocarAno('9')">9Âº Ano</button>
</div>

<br>

<input id="nome" placeholder="Nome">
<input id="classe" placeholder="Classe">
<button onclick="addAluno()">Adicionar</button>

<hr>

<div id="lista"></div>

<script>
/* =========================
   CONFIG
========================= */

const URL = "https://vfuebmcphgzwzjrgqadb.supabase.co/rest/v1/alunos";
const KEY = "sb_publishable_vcF6RN4YQJQ6PY4O5QOhLw_CvvJALr6";

let alunos=[];
let anoAtual="6";


/* =========================
   HELPERS API
========================= */

async function api(method, body=null, filtro=""){
  const r = await fetch(URL+filtro,{
    method,
    headers:{
      "apikey":KEY,
      "Authorization":"Bearer "+KEY,
      "Content-Type":"application/json",
      "Prefer":"return=representation"
    },
    body: body ? JSON.stringify(body) : null
  });

  return r.json();
}


/* =========================
   CARREGAR
========================= */

async function carregar(){
  alunos = await api("GET");
  render();
}

carregar();


/* =========================
   TROCAR ANO
========================= */
function trocarAno(a){
  anoAtual=a;
  render();
}


/* =========================
   ADICIONAR
========================= */
async function addAluno(){

  if(!nome.value) return;

  await api("POST",{
    ano:anoAtual,
    nome:nome.value,
    classe:classe.value,
    nivel:1,
    xp:0,
    foto:""
  });

  nome.value="";
  classe.value="";

  carregar();
}


/* =========================
   BUSCAR
========================= */
function get(id){
  return alunos.find(a=>a.id===id);
}


/* =========================
   XP
========================= */
async function addXP(id,val){

  let a=get(id);

  let xp=a.xp+val;
  let nivel=a.nivel;

  while(xp>=1000){
    xp-=1000;
    nivel++;
  }

  await api("PATCH",{xp,nivel},`?id=eq.${id}`);

  carregar();
}


/* =========================
   EDITAR
========================= */
async function editar(id){

  let a=get(id);

  const n=prompt("Nome:",a.nome);
  if(!n) return;

  const c=prompt("Classe:",a.classe);

  await api("PATCH",{nome:n,classe:c},`?id=eq.${id}`);

  carregar();
}


/* =========================
   EXCLUIR
========================= */
async function excluir(id){

  if(!confirm("Excluir aluno?")) return;

  await api("DELETE",null,`?id=eq.${id}`);

  carregar();
}


/* =========================
   FOTO
========================= */
function uploadFoto(id){

  const input=document.createElement("input");
  input.type="file";
  input.accept="image/*";

  input.onchange=()=>{
    const reader=new FileReader();

    reader.onload=async ()=>{
      await api("PATCH",{foto:reader.result},`?id=eq.${id}`);
      carregar();
    };

    reader.readAsDataURL(input.files[0]);
  };

  input.click();
}


/* =========================
   RENDER
========================= */
function render(){

  lista.innerHTML="";

  alunos
    .filter(a=>a.ano===anoAtual)
    .sort((a,b)=>(b.nivel*1000+b.xp)-(a.nivel*1000+a.xp))
    .forEach(a=>{

      let pct=(a.xp/1000)*100;

      lista.innerHTML+=`
        <div class="card">
          <img class="foto" src="${a.foto||''}">
          <div style="flex:1">
            <strong>${a.nome}</strong> â€” Nv ${a.nivel}<br>
            ${a.classe}

            <div class="bar">
              <div class="fill" style="width:${pct}%"></div>
            </div>

            XP ${a.xp}/1000<br>

            <button onclick="addXP(${a.id},5)">+5</button>
            <button onclick="addXP(${a.id},10)">+10</button>
            <button onclick="addXP(${a.id},20)">+20</button>
            <button onclick="addXP(${a.id},30)">+30</button>
            <button onclick="addXP(${a.id},50)">+50</button>

            <button onclick="editar(${a.id})">âœï¸</button>
            <button onclick="excluir(${a.id})">ğŸ—‘ï¸</button>
            <button onclick="uploadFoto(${a.id})">ğŸ“·</button>
          </div>
        </div>
      `;
    });
}
</script>
</body>
</html>
